<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Closed Circuit Simulation</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
  <style>
    .form-container {
        display: flex;
        justify-content: space-between;
        gap: 2em;
        flex-wrap: wrap;
        max-width: 1000px;
        margin-top: 1.5em;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 0.5em;
      font-size: 1em;
    }

    .column {
        flex: 1;
        min-width: 300px;
    }

    body {
        font-family: Arial, sans-serif;
        margin: 30px;
        background-color: #f9f9f9;
    }

    h1 {
        text-align: center;
        color: #333;
    }

    .inputs {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .input-group {
        display: inline-block;
        flex-direction: column;
        min-width: 200px;
    }

    label {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .input-group label {
        font-weight: 500;
        margin-bottom: 0.3em;
    }

    .input-group input {
        padding: 0.4em;
    }

    input,
    select {
        padding: 6px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    button {
        display: block;
        margin: 0 auto 20px auto;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    #d-value {
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        color: #444;
    }

    .charts {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .chart-container {
        width: 300px;
    }

    a {
        display: block;
        text-align: center;
        margin-top: 30px;
        text-decoration: none;
        color: #007bff;
    }
</style>
</head>
<body>
  <h1>Closed Circuit Simulation</h1>
  <div style="margin-top: 1em; font-weight: bold;">Experimental parameters:</div>

    <div class="inputs">
        <div class="input-group">
          <label for="Qf">Qf (mL/min):</label>
          <input id="Qf" value="6">
        </div>
        <div class="input-group">
          <label for="Qm">Qm (mL/min):</label>
          <input id="Qm" value="14">
        </div>
        <div class="input-group">
          <label for="dQ">leakage (mL/min):</label>
          <input id="dQ" value="1">
        </div>
        <div class="input-group">
          <label for="W">lobule weight (g):</label>
          <input id="W" value="30">
        </div>
        <div class="input-group">
          <label for="V0">Starting reservoir volume (mL):</label>
          <input id="V0" value="500">
        </div>
      </div>

    </div>
        
    <div style="margin-top: 1em; font-weight: bold;">Experimental data input:</div>

    <div class="form-container">
        <!-- Column 1 -->
        <div class="column">
          <div class="section-title">Sampling Volumes (mL):</div>
          <div class="inputs">
            <div class="input-group">
                <label for="vsFR">v<sup>S</sup><sub>FR</sub>:</label>
                <input id="vsFR" value="5">
            </div>
            <div class="input-group">
                <label for="vsMR">v<sup>S</sup><sub>MR</sub>:</label>
                <input id="vsMR" value="5">
            </div>
            <div class="input-group">
                <label for="vsFD">v<sup>S</sup><sub>FD</sub>:</label>
                <input id="vsFD" value="5">
            </div>
            <div class="input-group">
                <label for="vsMD">v<sup>S</sup><sub>MD</sub>:</label>
                <input id="vsMD" value="0">
            </div>
          </div>
        </div>
      
        <!-- Column 2 -->
        <div class="column">
          <div class="section-title">Sampling timepoints (min):</div>
          <div class="inputs">
            <div class="input-group">
              <label for="TsFR">T<sup>S</sup><sub>FR</sub>:</label>
              <input id="TsFR" value="0, 60, 120, 180, 240, 300">
            </div>
            <div class="input-group">
              <label for="TsMR">T<sup>S</sup><sub>MR</sub>:</label>
              <input id="TsMR" value="0, 60, 120, 180, 240, 300">
            </div>
            <div class="input-group">
              <label for="TsFD">T<sup>S</sup><sub>FD</sub>:</label>
              <input id="TsFD" value="0, 60, 120, 180, 240, 300">
            </div>
            <div class="input-group">
              <label for="TsMD">T<sup>S</sup><sub>MD</sub>:</label>
              <input id="TsMD" value=" ">
            </div>
          </div>
        </div>
      
        <!-- Column 3 -->
        <div class="column">
          <div class="section-title">Sample concentrations (mg/mL)</div>
          <div class="inputs">
            <div class="input-group">
              <label for="cFR">c<sub>F</sub>:</label>
              <input id="cFR" value="0, 0.2, 0.3, 0.3, 0.3, 0.4">
            </div>
            <div class="input-group">
              <label for="cMR">c <sub>M</sub>:</label>
              <input id="cMR" value="1, 0.7, 0.5, 0.4, 0.4, 0.4">
            </div>
            <div class="input-group">
                <label for="cFD">c<sub>f</sub>:</label>
              <input id="cFD" value="0, 0.4, 0.4, 0.4, 0.4, 0.4">
            </div>
            <div class="input-group">
              <label for="cMD">c <sub>m</sub>:</label>
              <input id="cMD" value="">
            </div>
          </div>
        </div>
      </div>

    <div style="margin-top: 1em; font-weight: bold;">Modelling parameters:</div>

    <div class="inputs">
        
            <div class="input-group">
                <label for="C0">C <sub>0</sub> (mg/mL):</label>
                <input id="C0" value="1">
            </div>
            <div class="input-group">
              <label for="D0">D <sub>0</sub>:</label>
              <input id="D0" value="1">
            </div>
        </div>
    </div>

  <br><br>
  <button id="simulateButton">Run Simulation</button>

  <div id="plot" style="width: 100%; height: 500px;"></div>

<a href="index.html">Back to Home</a>
    
  <script>
    function getArray(id) {
      const val = document.getElementById(id).value.trim();
      if (!val) return [];
      return val
      .split(',')
      .map(s => parseFloat(s.trim()))
      .filter(x => !isNaN(x));
    }
    

function simulate() {
  const getVal = id => parseFloat(document.getElementById(id).value) || 0;
  const Qm = parseFloat(document.getElementById('Qm').value);
  const Qf = parseFloat(document.getElementById('Qf').value);
  const dQ = parseFloat(document.getElementById('dQ').value);
  const W = parseFloat(document.getElementById('W').value);
  const V0 = parseFloat(document.getElementById('V0').value);
  const vsFR = parseFloat(document.getElementById('vsFR').value) || 0;
  const vsFD = parseFloat(document.getElementById('vsFD').value) || 0;
  const vsMR = parseFloat(document.getElementById('vsMR').value) || 0;
  const vsMD = parseFloat(document.getElementById('vsMD').value) || 0;
  const TsFR = getArray('TsFR');
  const TsFD = getArray('TsFD');
  const TsMR = getArray('TsMR');
  const TsMD = getArray('TsMD');
  const cFR = getArray('cFR');
  const cFD = getArray('cFD');
  const cMR = getArray('cMR');
  const cMD = getArray('cMD');
  const C0 = parseFloat(document.getElementById('C0').value);
  const D0 = parseFloat(document.getElementById('D0').value);

  // Calculate observed ratios where TsFR and TsMR have matching time points

  
  const obsTimes = TsFR.filter(t => TsMR.includes(t));

  const obsRatios = obsTimes.map(t => {
    const iFR = TsFR.findIndex(time => time === t);
    const iMR = TsMR.findIndex(time => time === t);
    const cf = cFR[iFR];
    const cm = cMR[iMR];
    return cm !== 0 ? cf / cm : 0;
  });

  if (!obsTimes || obsTimes.length === 0) {
    console.warn("No overlapping observation times found.");
    return;
  }

  const Vm = W * 0.34;
  const Vf = W * 0.074;

  const sampleVolume = (t, T_SR, T_SD, v_SR, v_SD) => {
    const nR = (T_SR || []).filter(time => time <= t).length;
    const nD = (T_SD || []).filter(time => time <= t).length;
    return (v_SR || 0) * nR + (v_SD || 0) * nD;
  }

  function safeVolume(vol, label, t) {
    if (vol <= 0) {
      const msg = `${label} volume became non-positive at t=${t.toFixed(2)}: ${vol.toFixed(4)} mL`;
      console.warn(msg);
      return 1e-6;
    }
    return vol;
  }
  
  function volumeRM(t) {
    const vol = -t * dQ + V0 - sampleVolume(t, TsMR, TsMD, vsMR, vsMD);
    return safeVolume(vol, "V_M", t);
  }

  function volumeRF(t) {
    const vol = t * dQ + V0 - sampleVolume(t, TsFR, TsFD, vsFR, vsFD);
    return safeVolume(vol, "V_F", t);
  }

  const tspan = Array.from(new Set([...TsFR, ...TsMR])).sort((a, b) => a - b);
  const y0 = [0, 0, C0, 0]; // Initial guess for concentrations

  function simulateModel(Dt) {
    function odefunc(t, y) {
      const Qrm = Qm + dQ;
      const Qrf = Qf - dQ;
      const safe = (x, min = 1e-6) => Math.max(x, min);
      const VRM = safe(volumeRM(t));
      const VRF = safe(volumeRF(t));
      return [
        (Qm * y[2] - Qrm * y[0] - Dt * (y[0] - y[1]) + dQ * y[1]) / Vm,
        (Qf * (y[3] - y[1]) + Dt * (y[0] - y[1])) / Vf,
        Qrm * (y[0] - y[2]) / VRM,
        Qrf * (y[1] - y[3]) / VRF
      ];
    }
    const solver = numeric.dopri(tspan[0], tspan[tspan.length - 1], y0, odefunc, 1e-8, 10000, undefined, true);
    return obsTimes.map(t => {
      const y = solver.at(t);
      return y[2] !== 0 ? y[3] / y[2] : 0;
    });
  }

  function cost(Dt) {
    const sim = simulateModel(Dt);
    return numeric.norm2Squared(numeric.sub(obsRatios, sim));
  }

  // Gradient descent to minimize cost(Dt)
  let Dt = D0;
  let learningRate = 0.01;
  let maxIter = 1000;
  let tolerance = 1e-6;

  function gradient(f, x, h = 1e-5) {
    return (f(x + h) - f(x - h)) / (2 * h);
  }

  for (let i = 0; i < maxIter; i++) {
    let grad = gradient(cost, Dt);
    let nextDt = Dt - learningRate * grad;

    if (!isFinite(nextDt)) break;
    if (Math.abs(nextDt - Dt) < tolerance) break;

    Dt = nextDt;
  }

  const bestDt = Dt;

  function odefuncDt(t, y) {
    const Qrm = Qm + dQ;
    const Qrf = Qf - dQ;
    const safe = (x, min = 1e-6) => Math.max(x, min);
    const VRM = safe(volumeRM(t));
    const VRF = safe(volumeRF(t));
    return [
      (Qm * y[2] - Qrm * y[0] - bestDt * (y[0] - y[1]) + dQ * y[1]) / Vm,
      (Qf * (y[3] - y[1]) + bestDt * (y[0] - y[1])) / Vf,
      Qrm * (y[0] - y[2]) / VRM,
      Qrf * (y[1] - y[3]) / VRF
    ];
  }

  const fullSolution = numeric.dopri(tspan[0], tspan[tspan.length - 1], y0, odefuncDt, 1e-8, 10000, undefined, true); 
  const modelTimes = tspan;
  const modelRatios = tspan.map(t => {const y = fullSolution.at(t); return y[2] > 0 ? y[3] / y[2] : 0;});

  function computeRSquared(observed, predicted) {
    const meanObs = numeric.sum(observed) / observed.length;
    const ssTot = numeric.sum(observed.map(y => Math.pow(y - meanObs, 2)));
    const ssRes = numeric.sum(observed.map((y, i) => Math.pow(y - predicted[i], 2)));
    return 1 - ssRes / ssTot;
  }

const rSquared = computeRSquared(obsRatios, simulateModel(bestDt));

  Plotly.newPlot('plot', [
    {
      x: obsTimes,
      y: obsRatios,
      mode: 'markers',
      name: 'Observed cF / cM',
      marker: { color: 'red', symbol: 'x' }
    },
    {
      x: modelTimes,
      y: modelRatios,
      mode: 'lines+markers',
      name: 'Fitted Model',
      line: { color: 'black' }
    }
  ], {
    title: `Fitted Dt = ${bestDt.toFixed(4)}, R² = ${rSquared.toFixed(4)}`,
    xaxis: { title: 'Time (min)' },
    yaxis: { title: 'cF / cM' }
  });
}

window.onload = function () {
  document.getElementById('simulateButton').addEventListener('click', simulate);
};

</script>

</body>
</html>
